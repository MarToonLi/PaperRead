### 《Auto-Exposure Fusion for Single-Image Shadow Removal》

#### 摘要

阴影去除任务的难度：阴影去除任务，难再与其内在的背景相关性和空间变化性，而引起的未知的多样的阴影模式。

本文方案：将其构造为一个exposure fusion problem 曝光融合问题。直观地：

- 首先估计多个过渡曝光的图片w.r.t.输入图片，以使得这些图片中的阴影区域和输入图片中的无阴影区域具有相同的颜色。
- 然后，将原始的输入图片和过渡曝光的图片融合，以生成最终的无阴影counterpart相对的图片。

**然而，**阴影的时空变化性需要这种融合足够的smart，也就是，这种融合应该自动地从不同的图片中，恰当地选择出**过渡曝光的像素**，以使最终的输出更加自然。

为了实现这种smart：

- 提出可以感知阴影的融合网络，shadow-aware FusionNet。

    它将阴影图片作为输入，以生成融合权重，权重再映射到所有的过渡曝光的图片上。

- 提出了感知边界的改进网络，shadow-aware FusionNet。

    它能进一步地消除剩余的阴影痕迹。

实验所用的数据集：ISTD，ISTD+，SRD。

#### 引言

阴影区域中呈现的空间变化颜色和照明失真可能会阻碍视觉任务的性能，比如物体检测和物体追踪，物体识别和语义分割。

先前的解决思路，要么基于**成对阴影和无阴影图像的物理阴影模型**对该任务进行建模[17]，要么将其建模为基于**未配对阴影和无阴影图像**的生成对抗网络（GAN）的图像到图像转换问题。

**然而，**通过基于GAN的方法学习到的阴影去除转换：

- 倾向于生成人工特征以及使图片模糊。
- 遭受着数据分布的要求，因为这些模型期望未配对的阴影模型和无阴影的图片数据集能够共享统计相似，而这一点，在数据采集不稳定的时候，这一点是很难满足的。
- 另一方面，公开的配对阴影和无阴影图片的数据集，允许阴影去除任务，学习到一个物理上很真实的转换，以一种有监督学习的方式。

本文，将专注于成对的训练数据以执行阴影去除任务。



阴影降低了图片的质量，颜色和光亮都受到影响，阴影图片的过渡曝光是一种加强图片质量的有效方法。直观地来说，将过度曝光的图片和原始的阴影图片融合，能够获得想要的无阴影图片。

最近的阴影分解研究：

- 【17，18】基于物理阴影模型，主要学习使阴影图片relight到一个明亮的版本，然后将前后两种图片融合以获得想要的无阴影图片，这是一种阴影蒙板的操作方式。

    - 但是，因为**阴影投射**会以依赖于背景和空间变化的方式**降低整个空间区域的颜色和照明**（比如说，在背景图像上**投射的连续阴影**可能导致阴影区域根据原始无阴影背景区域的外观以及阴影在背景图像上空间投射的位置而不同地显示）

    - 我们认为**多重过曝光融合具有更高的灵活性**，可以提供更好的解决方案来补偿阴影区域，使其与非阴影区域具有相同的颜色和照明，并更好地恢复阴影区域的基本内容。

未知的多样的阴影模式对现有的DNN方法，引起两个挑战：

- 阴影去除是一项依赖背景的任务，这一点需要DNN不仅仅恢复和无阴影区域一致的光亮和颜色，而且要求其保留阴影下的内容。

    阴影的空间变化性质又要求这种融合，应当足够灵活，以适应性地从不同地图片中选择想要的过度曝光地像素值，以得到最终的无阴影版本。

- 很难获得无痕迹的背景，因为阴影区域的边界和内部的阴影模式的不一致性。

本文，提出一种新方法—— 自动化曝光融合网络。

<img src="/home/cold/PaperReadFastly/PaperRead/论文阅读列表/2021年度/H 阴影去除/阴影去除.assets/image-20210924205622517.png" alt="image-20210924205622517" style="zoom: 67%;" />

- 首先，使用过度估计，以学习多重曝光图片，**通过用不同的曝光级别补偿阴影区域**。

- 然后，提出了感知阴影的融合网络，以输出融合权重映射图，**以解决上面提出的第一个挑战**。

    它能够灵活地选择那种过度曝光的像素值是最好的；

    这种方法实现了以一种pixel-wise的方式融合了输入图片和它的过度曝光版本。

- 进一步，提出一个边界感知-改进网络，以移除剩余的阴影痕迹以改进上一布获得的去除结果。

本文的贡献：

- 这是第一篇从自动曝光融合的视角以研究阴影去除问题的研究；
- 为了加速去除阴影，作者提出了一种可学习的阴影感知融合网络，和一个边界感知的改进网络，以加速估计，灵活融合同时meticulously极度仔细地改进多重过度曝光映射。
- comparable performance in non-shadow regions 比肩。



#### 相关工作

**阴影去除：**

传统的阴影去除方法，使用先验信息：梯度，光亮和区域。

而最近的深度学习方法，表现优异，因为出现了大规模的配对和未配对的数据集。

- 【27】提出多重上下文特征，涉及全局定位，外貌和语义，以预测一个阴影蒙板层。
- 【32】通过一个叠加的GAN框架实现对阴影的检测和去除。
- 【37】使用感知方向的信息以提升对阴影的检测和去除能力。
- 【17】提出一种从阴影解构的角度去除阴影的方法。

基于GAN的模型使得未配对阴影上阴影的去除变为肯呢各，通过将器视为一种图片对图片的翻译问题。**然而**，这些方法

- 遭受着人工制品和图像模糊的困境。
- 同时也需要未配对阴影和无阴影图片数据集拥有相似的统计分布。

**曝光融合：**

普遍的图片传感器捕获范围通常是有限的，一张图片往往会显得过度曝光或者缺乏曝光。

而多重曝光图片融合能够改进图片的质量。

> 如果对loss函数定义合理，是否也可以用于提升质量。

传统的多重曝光图片融合方法MEF，一般地是局部融合或者使用人工设计的特征。

- 【8】提出了一种patch-wise的MEF方法；
- 【23】【19】

最近的深度学习方法，由于高级表示的能力，提升了融合的性能。

- 【26】使用多重曝光融合的方式以一种无监督的方式，**通过采用一个无参考图像质量损失函数**

同时最近的一些研究也研究了MEF方法对于图片分类的影响。

#### 方法

我们建议**将阴影去除作为曝光融合问题来描述**，以恢复阴影图像中的**无痕迹**背景。

- 1 揭露挑战；
- 2 解释生成多重曝光图片融合的原因。
- 3 感知阴影的融合网络；
- 4 边界感知的融合网络。

##### 3.1 阴影去除的曝光融合

描述一个函数：

![image-20210924213623070](/home/cold/PaperReadFastly/PaperRead/论文阅读列表/2021年度/H 阴影去除/阴影去除.assets/image-20210924213623070.png)

- 函数表示一个转换函数，将一个阴影图片对应到一个无阴影图片。
- 核心主张：为了提高阴影图像的图像质量，**对多幅曝光图像的括号进行曝光融合**，可以得到曝光良好的图像，即无阴影图像。而使用过度曝光图片的目的在于补偿阴影区域以使其获得相同的颜色和光亮。

![image-20210924213631358](/home/cold/PaperReadFastly/PaperRead/论文阅读列表/2021年度/H 阴影去除/阴影去除.assets/image-20210924213631358.png)

- 新增的符号对应阴影图片的第i个过度曝光图片。

- 一种直观的解决思路是，估计出一张过度曝光的阴影图片的版本，进而融合以获得想要的无阴影图片。

    然而，阴影区域具有背景依赖型和空间变化性的。不同阴影区域中的颜色和光亮是不同的。**单张过度曝光的图片很难适应性反映空间中的退化。**

##### 3.2 过度曝光序列的生成

- 通过channel-wise；

![image-20210925102949919](/home/cold/PaperReadFastly/PaperRead/论文阅读列表/2021年度/H 阴影去除/阴影去除.assets/image-20210925102949919.png)

- 借助原始的阴影图片和两个参数，得到过度曝光的图片。
- alpha控制曝光的程度；贝塔 决定潜在程度转移。
- 训练一个DNN模型以适应性地估计这两个参合苏，通过将该**阴影图片和阴影mask**作为输入。（其中阴影图片和阴影mask两张图片是数据集提供的）

因为如果直接训练出所有的N对曝光参数，比较难，因此选择两阶段法：

- 首先，训练一个DNN模型估计中等曝光程度的两个参数；

    ![image-20210925104138395](/home/cold/PaperReadFastly/PaperRead/论文阅读列表/2021年度/H 阴影去除/阴影去除.assets/image-20210925104138395.png)

- 其次，通过一个简单的插值操作，基于一个假设：过度曝光序列的图片拥有相似的颜色，同时差异很小。

    ![image-20210925104150600](/home/cold/PaperReadFastly/PaperRead/论文阅读列表/2021年度/H 阴影去除/阴影去除.assets/image-20210925104150600.png)

    - gamma 表示 插值的系数。

- 由此，问题变成了：训练DNN网络的问题了。

    - 而alpha belta 的中等程度取值，对阴影图像及其无阴影对应物的阴影遮罩覆盖区域执行最小二乘法而得到。
    - 优化：估计参数和真实值之间的均方误差。
    - 其中的曝光参数是独立于不同的颜色通道的，以适应性地调整因为阴影引起的颜色失真问题。

##### 3.3 阴影感知融合网络

每张被融合的图片，包含原始的图片，会被分配一个权重，该权重面向每一张图片每个通道的每一个像素值。

但是这样的融合策略，忽视了局部平滑，将会引起匮乏的自然性或者甚至噪音融合的结果。

![image-20210925114251578](/home/cold/PaperReadFastly/PaperRead/论文阅读列表/2021年度/H 阴影去除/阴影去除.assets/image-20210925114251578.png)

星号表示，像素级别的卷积：但是该kernal**并不向其他的卷积核一样被其他的像素点共享**！

**具体来说就是**，第i个张图片的第p个像素以及其相邻像素，通过一个exclusive独有的卷积核，线性组合。

- 而这种通过考虑邻居像素点的方式，可以避免潜在的噪音结果。

最终，问题成了如何得到每个像素点对应的卷积核。

- 通过CNN网络，将阴影图片和阴影mask作为引导。为此，融合网络需要理解阴影图片然后预测卷积核，卷积核可以在空间层次适应不同的阴影遮挡内容，因此，可以从多重遮挡图片中选择适合的像素以去除阴影。



![image-20210925125030782](/home/cold/PaperReadFastly/PaperRead/论文阅读列表/2021年度/H 阴影去除/阴影去除.assets/image-20210925125030782.png)

- Shadow mask I m acts as a fusion guidance for FusionNet to let it assign low weights to non-shadow region and focus mostly on the shadow region。其中的阴影mask的作用：是一种引导的作用，使得网络能够将低权重分配给无阴影的区域，而专注于阴影区域。

- 模型的损失函数：L1范式，像素级别

    ![image-20210925125334277](/home/cold/PaperReadFastly/PaperRead/论文阅读列表/2021年度/H 阴影去除/阴影去除.assets/image-20210925125334277.png)

##### 3.4 边界感知的改进网络

**遗留问题**：部分阴影（半影）像素沿阴影边界存在。而阴影边界和阴影区域的内部的阴影模式的不一致，是该任务的巨大挑战。以获得无痕迹的背景。

**方法：**边界感知的改进网络

![image-20210925154353528](/home/cold/PaperReadFastly/PaperRead/论文阅读列表/2021年度/H 阴影去除/阴影去除.assets/image-20210925154353528.png)

![image-20210925155408313](/home/cold/PaperReadFastly/PaperRead/论文阅读列表/2021年度/H 阴影去除/阴影去除.assets/image-20210925155408313.png)

- 它的功能在于，从融合网络中获取到的结果的改进；

- 功能函数：

    ![image-20210925154520701](/home/cold/PaperReadFastly/PaperRead/论文阅读列表/2021年度/H 阴影去除/阴影去除.assets/image-20210925154520701.png)

    - mb 表示 半影，F 函数仍然是一个pixel级别的改进核，它将一定范围内的邻域的像素核中心像素融合以移除遗留的痕迹。

    - 公式：

        ![image-20210925154851591](/home/cold/PaperReadFastly/PaperRead/论文阅读列表/2021年度/H 阴影去除/阴影去除.assets/image-20210925154851591.png)

        - Fp表示一个卷积核；

    - 输入：阴影图片s，阴影maskm，半影掩码mb，初始阴影移除结果I`。

        - mb 扮演一个引导的角色，使得阴影边界、无阴影区域和移除的阴影的颜色和光亮程度一致。
        - mb 是通过计算扩张阴影和缩放阴影的差异得到的。

    - 损失函数：像素级别的L1范式 + 边界感知损失函数以seamlessly remove the shadow无缝去除。其中边界损失函数：

        ![image-20210925155609217](/home/cold/PaperReadFastly/PaperRead/论文阅读列表/2021年度/H 阴影去除/阴影去除.assets/image-20210925155609217.png)

        - 倒三角：表示拉普拉斯梯度操作算子。它的目标是最小化沿阴影边界的梯度域。它保持了非阴影区域的相同梯度域。同时，减少了梯度域的差异

#### 3.5 执行细节

实验图片 256；batch_size 8；学习率 0.0001；优化器 Adam。400 epoch。

